<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <style>
        /* Custom styles for the dashboard */
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        h3 {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div x-data="tradeDashboard()" x-init="init()">
        <!-- Enable/Disable Trade Buttons -->
        <div>
            <button @click="enablePut()">Enable PUT</button>
            <button @click="enableCall()">Enable CALL</button>
            <button @click="enableBoth()">Enable BOTH</button>
            <button @click="forceExit()">Force EXIT</button>
        </div>

        <!-- Current Positions -->
        <h3>Current Positions</h3>
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Current Price</th>
                    <th>Highest Price</th>
                    <th>Trailing SL</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="position in currentPositions" :key="position.trade_id">
                    <tr>
                        <td x-text="position.symbol_name"></td>
                        <td x-text="position.current_price"></td>
                        <td x-text="position.highest_price"></td>
                        <td x-text="position.trailing_sl_price"></td>
                    </tr>
                </template>
            </tbody>
        </table>

        <!-- Historical Positions -->
        <h3>Historical Positions</h3>
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Entry Price</th>
                    <th>Entry Time</th>
                    <th>Exit Time</th>
                    <th>Exit Type</th>
                    <th>PNL</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="history in historicalPositions" :key="history.trade_id">
                    <tr>
                        <td x-text="history.symbol_name"></td>
                        <td x-text="history.entry_price"></td>
                        <td x-text="history.entry_time"></td>
                        <td x-text="history.exit_time"></td>
                        <td x-text="history.exit_type"></td>
                        <td x-text="history.pnl"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <script>
        function tradeDashboard() {
            return {
                currentPositions: [],
                historicalPositions: [],
                ws: null,

                // Initialize WebSocket and functions
                init() {
                    console.log("Initializing WebSocket...");
                    this.connectWebSocket();
                },

                // Connect to the WebSocket server
                connectWebSocket() {
                    this.ws = new WebSocket("ws://localhost:8000/ws/trade_updates");

                    // Handle WebSocket connection open
                    this.ws.onopen = () => {
                        console.log("WebSocket connected.");
                    };

                    // Handle incoming messages from WebSocket
                    this.ws.onmessage = (event) => {
                        console.log("WebSocket Message Received: ", event.data);  // Log received data

                        const data = JSON.parse(event.data);

                        if (data.event === "trade_updated") {
                            console.log("Processing trade updates...");

                            // Find the position in currentPositions array
                            const positionIndex = this.currentPositions.findIndex(pos => pos.trade_id === data.data.trade_id);

                            if (positionIndex !== -1) {
                                // Update the existing position
                                this.currentPositions[positionIndex] = data.data;
                            } else {
                                // Add new position if not found
                                this.currentPositions.push(data.data);
                            }
                        } else if (data.event === "trade_entered") {
                            console.log("Processing trade entered...");
                            // Handle trade entered event
                            this.currentPositions.push(data.data);
                        } else if (data.event === "trade_exited") {
                            console.log("Processing trade exited...");
                            // Handle trade exited event
                            this.currentPositions = this.currentPositions.filter(pos => pos.trade_id !== data.data.trade_id);

                            // Ensure all necessary fields are included in the historical position
                            const historicalPosition = {
                                trade_id: data.data.trade_id,
                                symbol_name: data.data.symbol_name,
                                entry_price: data.data.entry_price,
                                entry_time: data.data.entry_time,
                                exit_time: data.data.exit_time,
                                exit_type: data.data.exit_reason,
                                pnl: data.data.profit_loss
                            };

                            this.historicalPositions.push(historicalPosition);
                        } else {
                            console.log("Unknown event: ", data.event);
                        }
                    };

                    // Handle WebSocket errors
                    this.ws.onerror = (error) => {
                        console.error("WebSocket error: ", error);
                    };

                    // Reconnect WebSocket when it's closed
                    this.ws.onclose = () => {
                        console.warn("WebSocket closed, reconnecting...");
                        setTimeout(() => this.connectWebSocket(), 3000);  // Retry in 3 seconds
                    };
                },

                // Define button actions (FastAPI endpoints)
                enablePut() {
                    fetch('/enable_put', { method: 'POST' });
                },
                enableCall() {
                    fetch('/enable_call', { method: 'POST' });
                },
                enableBoth() {
                    fetch('/enable_both', { method: 'POST' });
                },
                forceExit() {
                    fetch('/force_exit', { method: 'POST' });
                }
            };
        }
    </script>
</body>
</html>